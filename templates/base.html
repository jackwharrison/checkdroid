<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}CheckDroid{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  {% set user_name = session.get("admin_username") or session.get("username") %}

  <header class="topbar">
    {% block topbar_left %}
    <div class="topbar-left">
      <button class="icon-btn" aria-label="Menu">☰</button>
      <div class="brand">
        <span class="brand-text">121 Portal</span>
        <span id="netPill" class="pill pill-online">
        <span class="pill-icon" id="netPillIcon"></span>
        <span id="netPillText">Online</span>
        </span>
      </div>
    </div>
    {% endblock %}

    <div class="topbar-right">
      {% if user_name %}
        <div class="header-account-wrapper">
          <div class="account-dropdown">
            <button
              class="account-btn"
              type="button"
              onclick="toggleAccountDropdown()"
              aria-haspopup="true"
              aria-expanded="false"
            >
              <img
                src="{{ url_for('static', filename='icons/user.svg') }}"
                class="account-icon-svg"
                alt=""
              >
              <span>Account</span>
              <img
                src="{{ url_for('static', filename='icons/arrow.svg') }}"
                class="account-arrow-svg"
                alt=""
              >
            </button>

            <div id="account-menu" class="account-menu hidden" role="menu">
              <div class="account-menu-item user-info">
                <strong>Logged in as:</strong><br>
                {{ user_name }}
              </div>

              <div class="account-menu-divider"></div>

              <a
                href="{{ url_for('logout') }}"
                class="account-menu-item"
                role="menuitem"
              >
                Logout
              </a>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </header>


  <main class="page {% block page_class %}{% endblock %}">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-wrap">
          {% for m in messages %}
            <div class="flash">{{ m }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <script>
    function toggleAccountDropdown() {
      const menu = document.getElementById('account-menu');
      const btn = document.querySelector('.account-btn');
      if (!menu || !btn) return;

      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      menu.classList.toggle('hidden');
      btn.classList.toggle('active');
    }

    document.addEventListener('click', function (e) {
      const menu = document.getElementById('account-menu');
      const btn = document.querySelector('.account-btn');
      if (!menu || !btn) return;

      // Click outside dropdown → close it
      if (!btn.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.add('hidden');
        btn.classList.remove('active');
        btn.setAttribute('aria-expanded', 'false');
      }
    });
    // Password visibility toggles
    document.addEventListener('DOMContentLoaded', function () {
        var toggles = document.querySelectorAll('.password-toggle');

        toggles.forEach(function (btn) {
        btn.addEventListener('click', function () {
            var field = btn.closest('.password-field');
            if (!field) return;

            var input = field.querySelector('input');
            if (!input) return;

            var isHidden = input.type === 'password';
            input.type = isHidden ? 'text' : 'password';
            btn.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
            btn.classList.toggle('visible', isHidden);
        });
        });
    });

  </script>
<script>
  if ("serviceWorker" in navigator) {
    const disableSw = new URLSearchParams(location.search).get("nosw") === "1";
    if (!disableSw) {
      window.addEventListener("load", async () => {
        try {
          // If a SW already controls the page, do nothing
          if (navigator.serviceWorker.controller) return;

          // If an existing registration exists, do nothing
          const existing = await navigator.serviceWorker.getRegistration("/");
          if (existing) return;

          await navigator.serviceWorker.register("/sw.js");
        } catch (err) {
          console.warn("SW registration failed", err);
        }
      });
    }
  }
</script>
<script>
  (function () {
    const pill = document.getElementById("netPill");
    const text = document.getElementById("netPillText");
    if (!pill || !text) return;

    function setOnlineUI(isOnline) {
      pill.classList.toggle("pill-online", !!isOnline);
      pill.classList.toggle("pill-offline", !isOnline);
      text.textContent = isOnline ? "Online" : "Offline";
    }

    // Base signal
    setOnlineUI(navigator.onLine);

    window.addEventListener("online",  () => setOnlineUI(true));
    window.addEventListener("offline", () => setOnlineUI(false));

    // Optional: if you add the SW "FORCE_OFFLINE" test switch later,
    // you can override UI too by listening for a custom event.
    window.setForceOfflineUI = function (enabled) {
      setOnlineUI(!enabled);
    };
  })();
</script>

</body>
</html>
