<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Offline â€“ CheckDroid</title>
  <link rel="stylesheet" href="/static/styles.css?v=5">
  <link rel="icon" href="/static/favicon.ico">
</head>
<body>
  <div class="cards-container">
    <div class="cards-row" id="programCards">
      <!-- program cards injected by JS -->
    </div>
  </div>
  <div style="margin: 16px 0; color: #888; font-size: 0.95em;">
    <em>Offline mode: Program list may be limited to last synced data.</em>
  </div>

  <script>
    (function () {
      function escapeHtml(str) {
        return String(str ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function cardTemplate(program) {
        const id = program.id;
        const title = escapeHtml(program.title || `Program ${id}`);

        return `
          <article class="card card-program" data-program-id="${id}">
            <div class="card-main">
              <h2 class="card-title">${title}</h2>
              <div class="sync-row">
                <span class="sync-icon"></span>
                <span class="sync-status-text">
                  ${navigator.onLine ? "Syncing, keep this page open" : "Offline: Using cached data"}
                </span>
              </div>
              <div class="stats">
                <div class="stat">
                  <div class="stat-value validated-count">0</div>
                  <div class="stat-label">
                    Validated on this<br>device today
                  </div>
                </div>
                <div class="stat">
                  <div class="stat-value registrations-count">0</div>
                  <div class="stat-label">
                    Registrations<br>synced to device
                  </div>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <button
                class="btn btn-primary"
                type="button"
                onclick="window.location.href='/offline/validate'"
              >
                <div class="btn-content">
                  <span class="btn-icon"></span>
                  <span>Start validating</span>
                </div>
              </button>
            </div>
          </article>
        `;
      }

      function loadProgramsOffline() {
        let programs = [];
        try {
          const raw = localStorage.getItem("checkdroid_programs");
          if (raw) {
            programs = JSON.parse(raw);
          }
        } catch (e) {
          // ignore
        }
        const container = document.getElementById("programCards");
        if (!programs.length) {
          container.innerHTML = `
            <div class="muted small">
              No programs available offline.<br>
              (You need to sync at least once online for offline access.)
            </div>
          `;
          return;
        }
        container.innerHTML = programs.map(cardTemplate).join("");
      }

      loadProgramsOffline();
    })();
  </script>
</body>
</html>
