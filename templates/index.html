{% extends "base.html" %}
{% block title %}CheckDroid{% endblock %}

{% block content %}

  <div class="cards-container">
    <div class="cards-row" id="programCards">
      <!-- program cards injected by JS -->
    </div>
  </div>

  {# Load the sync + IndexedDB logic #}
  <script src="{{ url_for('static', filename='app.js') }}"></script>

  <script>
    (function () {
      function escapeHtml(str) {
        return String(str ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function cardTemplate(program) {
        const id = program.id;
        const title = escapeHtml(program.title || `Program ${id}`);

        return `
          <article class="card card-program" data-program-id="${id}">
            <div class="card-main">
              <h2 class="card-title">${title}</h2>

              <div class="sync-row">
                <span class="sync-icon"></span>
                <span class="sync-status-text">
                  Syncing, keep this page open
                </span>
              </div>

              <div class="stats">
                <div class="stat">
                  <div class="stat-value validated-count">0</div>
                  <div class="stat-label">
                    Validated on this<br>device today
                  </div>
                </div>
                <div class="stat">
                  <div class="stat-value registrations-count">0</div>
                  <div class="stat-label">
                    Registrations<br>synced to device
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer">
              <button
                class="btn btn-primary"
                type="button"
                onclick="window.location.href='/validate?program_id=${encodeURIComponent(id)}'"
              >
                <div class="btn-content">
                  <span class="btn-icon"></span>
                  <span>Start validating</span>
                </div>
              </button>
            </div>
          </article>
        `;
      }

        async function loadPrograms() {
        const res = await fetch("/api/programs");
        const data = await res.json();
        const programs = data.programs || [];
        const container = document.getElementById("programCards");

        // ADD THIS BLOCK:
        try {
            const slim = programs.map(p => ({
            id: p.id,
            title: p.title || `Program ${p.id}`
            }));
            localStorage.setItem("checkdroid_programs", JSON.stringify(slim));
        } catch (e) {
            console.warn("Could not persist programs for offline title lookup", e);
        }

        if (!programs.length) {
            container.innerHTML = `
            <div class="muted small">
                No programs available for this account.
            </div>
            `;
            return;
        }

        // Inject cards
        container.innerHTML = programs.map(cardTemplate).join("");

        // After cards exist, trigger sync for each
        if (typeof window.syncProgramCard === "function") {
            const cards = container.querySelectorAll(".card-program[data-program-id]");
            cards.forEach((card) => {
            const pid = parseInt(card.dataset.programId, 10);
            if (!pid) return;
            window.syncProgramCard(card, pid);
            });
        }
        }

      loadPrograms().catch(err => console.error("Failed to load programs", err));
    })();
  </script>

{% endblock %}
